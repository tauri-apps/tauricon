'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var fsExtra = require('fs-extra');
var isPng = require('is-png');
var path = require('path');
var png2icons = require('png2icons');
var readChunk = require('read-chunk');
var sharp = require('sharp');
var chalk = require('chalk');
var ms = require('ms');
var module$1 = require('module');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

function _interopNamespace(e) {
    if (e && e.__esModule) return e;
    var n = Object.create(null);
    if (e) {
        Object.keys(e).forEach(function (k) {
            if (k !== 'default') {
                var d = Object.getOwnPropertyDescriptor(e, k);
                Object.defineProperty(n, k, d.get ? d : {
                    enumerable: true,
                    get: function () { return e[k]; }
                });
            }
        });
    }
    n["default"] = e;
    return Object.freeze(n);
}

var isPng__default = /*#__PURE__*/_interopDefaultLegacy(isPng);
var path__default = /*#__PURE__*/_interopDefaultLegacy(path);
var png2icons__namespace = /*#__PURE__*/_interopNamespace(png2icons);
var sharp__default = /*#__PURE__*/_interopDefaultLegacy(sharp);
var chalk__default = /*#__PURE__*/_interopDefaultLegacy(chalk);
var ms__default = /*#__PURE__*/_interopDefaultLegacy(ms);

function _instanceof(left,right){if(right!=null&& typeof Symbol!=="undefined"&&right[Symbol.hasInstance]){return !!right[Symbol.hasInstance](left)}else {return left instanceof right}}function __awaiter(thisArg,_arguments,P,generator){var adopt=function adopt(value){return _instanceof(value,P)?value:new P(function(resolve){resolve(value);})};return new(P||(P=Promise))(function(resolve,reject){var fulfilled=function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}};var rejected=function rejected(value){try{step(generator["throw"](value));}catch(e){reject(e);}};var step=function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected);};step((generator=generator.apply(thisArg,_arguments||[])).next());})}function __generator(thisArg,body){var verb=function verb(n){return function(v){return step([n,v])}};var step=function step(op){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=op[0]&2?y["return"]:op[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[op[0]&2,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return {value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break}if(t[2])_.ops.pop();_.trys.pop();continue}op=body.call(thisArg,_);}catch(e){op=[6,e];y=0;}finally{f=t=0;}if(op[0]&5)throw op[1];return {value:op[0]?op[1]:void 0,done:true}};var _={label:0,sent:function sent(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},f,y,t,g;return g={next:verb(0),"throw":verb(1),"return":verb(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this}),g}

var prevTime;var logger=function logger(banner,color){if(color===void 0){color=chalk__default["default"].green;}return function(msg){var curr=+new Date;var diff=curr-(prevTime||curr);prevTime=curr;if(msg){console.log(" ".concat(color(String(banner))," ").concat(msg," ").concat(chalk__default["default"].green("+".concat(ms__default["default"](diff)))));}else {console.log();}}};

var _a;var warn$1=logger("tauri",chalk__default["default"].red);var require$2=module$1.createRequire((typeof document === 'undefined' ? new (require('u' + 'rl').URL)('file:' + __filename).href : (document.currentScript && document.currentScript.src || new URL('tauricon.cjs', document.baseURI).href)));var glob=require$2("glob");var getAppDir=function getAppDir(){var _a1;var dir=(_a1=process.env.__TAURI_TEST_APP_DIR)!==null&&_a1!==void 0?_a1:process.cwd();var matches=glob.sync(path.join(dir,"**/package.json"),{ignore:"**/node_modules/**"});if(matches.length===0){return null}else {return path.dirname(matches[0])}};var getTauriDir=function getTauriDir(){var _a2;var dir=(_a2=process.env.__TAURI_TEST_APP_DIR)!==null&&_a2!==void 0?_a2:process.cwd();var matches=glob.sync(path.join(dir,"**/tauri.conf.json"));if(matches.length===0){warn$1("Couldn't recognize the current folder as a part of a Tauri project. It must contain a `tauri.conf.json` file in any subfolder.");process.exit(1);return ""}else {return path.dirname(matches[0])}};var appDir=(_a=getAppDir())!==null&&_a!==void 0?_a:path.resolve(getTauriDir(),"..");var tauriDir=getTauriDir();

var options={background_color:"#000074",theme_color:"#02aa9b",sharp:"kernel: sharp.kernel.lanczos3",minify:{batch:false,overwrite:true,available:["optipng","zopfli"],type:"optipng",optipngOptions:{optimizationLevel:4,paletteReduction:true},zopfliOptions:{transparent:true,more:true}},splash_type:"generate",tauri:{linux:{folder:".",prefix:"",infix:true,suffix:".png",sizes:[32,128]},linux_2x:{folder:".",prefix:"128x128@2x",infix:false,suffix:".png",sizes:[256]},defaults:{folder:".",prefix:"icon",infix:false,suffix:".png",sizes:[512]},appx_logo:{folder:".",prefix:"StoreLogo",infix:false,suffix:".png",sizes:[50]},appx_square:{folder:".",prefix:"Square",infix:true,suffix:"Logo.png",sizes:[30,44,71,89,107,142,150,284,310]}}};

var require$1=module$1.createRequire((typeof document === 'undefined' ? new (require('u' + 'rl').URL)('file:' + __filename).href : (document.currentScript && document.currentScript.src || new URL('tauricon.cjs', document.baseURI).href)));var version=require$1("../package.json").version;var pngToIco=require$1("png-to-ico");var warn=logger("app:spawn",chalk__default["default"].red);var image=false;var spinnerInterval=null;var exists=function exists(file){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:_a.trys.push([0,2,,3]);return [4,fsExtra.access(file)];case 1:_a.sent();return [2,true];case 2:_a.sent();return [2,false];case 3:return [2]}})})};var checkSrc=function checkSrc(src){return __awaiter(void 0,void 0,void 0,function(){var srcExists,buffer,meta,stats;return __generator(this,function(_a){switch(_a.label){case 0:if(!(image!==false))return [3,1];return [2,image];case 1:return [4,exists(src)];case 2:srcExists=_a.sent();if(!!srcExists)return [3,3];image=false;if(spinnerInterval)clearInterval(spinnerInterval);warn("[ERROR] Source image for tauricon not found");process.exit(1);return [3,8];case 3:return [4,readChunk.readChunk(src,{startPosition:0,length:8})];case 4:buffer=_a.sent();if(!isPng__default["default"](buffer))return [3,7];image=sharp__default["default"](src);return [4,image.metadata()];case 5:meta=_a.sent();if(!meta.hasAlpha||meta.channels!==4){if(spinnerInterval)clearInterval(spinnerInterval);warn("[ERROR] Source png for tauricon is not transparent");process.exit(1);}return [4,image.stats()];case 6:stats=_a.sent();if(stats.isOpaque){if(spinnerInterval)clearInterval(spinnerInterval);warn("[ERROR] Source png for tauricon could not be detected as transparent");process.exit(1);}return [2,image];case 7:image=false;if(spinnerInterval)clearInterval(spinnerInterval);warn("[ERROR] Source image for tauricon is not a png");process.exit(1);_a.label=8;case 8:return [2]}})})};var uniqueFolders=function uniqueFolders(options){var folders=[];for(var type in options){var option=options[String(type)];if(option.folder){folders.push(option.folder);}}folders=folders.sort().filter(function(x,i,a){return !i||x!==a[i-1]});return folders};var hexToRgb=function hexToRgb(hex){var shorthandRegex=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;hex=hex.replace(shorthandRegex,function(m,r,g,b){return r+r+g+g+b+b});var result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return result?{r:parseInt(result[1],16),g:parseInt(result[2],16),b:parseInt(result[3],16)}:undefined};var validate=function validate(src,target){return __awaiter(void 0,void 0,void 0,function(){var res;return __generator(this,function(_a){switch(_a.label){case 0:if(!(target!==undefined))return [3,2];return [4,fsExtra.ensureDir(target)];case 1:_a.sent();_a.label=2;case 2:return [4,checkSrc(src)];case 3:res=_a.sent();return [2,res]}})})};var progress=function progress(msg){process.stdout.write("  ".concat(msg,"                       \r"));};var spinner=function spinner(){if("CI"in process.env||process.argv.some(function(arg){return arg==="--ci"})){return null}return setInterval(function(){process.stdout.write("/ \r");setTimeout(function(){process.stdout.write("- \r");setTimeout(function(){process.stdout.write("\\ \r");setTimeout(function(){process.stdout.write("| \r");},100);},100);},100);},500)};var tauricon={validate:function validate1(src,target){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return [4,validate(src,target)];case 1:_a.sent();return [2,typeof image==="object"]}})})},version:function version1(){return version},make:function make(src,target,strategy,options$1){if(target===void 0){target=path__default["default"].resolve(tauriDir,"icons");}return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:if(!src){src=path__default["default"].resolve(appDir,"app-icon.png");}spinnerInterval=spinner();options$1=options$1||options.tauri;progress('Building Tauri icns and ico from "'.concat(src,'"'));return [4,this.validate(src,target)];case 1:_a.sent();return [4,this.icns(src,target)];case 2:_a.sent();progress("Building Tauri png icons");return [4,this.build(src,target,options$1)];case 3:_a.sent();progress("Tauricon Finished");if(spinnerInterval)clearInterval(spinnerInterval);return [2,true]}})})},build:function build(src,target,options){return __awaiter(this,void 0,void 0,function(){var sharpSrc,buildify2,output,folders,n,folder,_a1,_b,_i,optionKey,option,_c,_d,_e,sizeKey,size,dest,pvar1;return __generator(this,function(_f){switch(_f.label){case 0:return [4,this.validate(src,target)];case 1:_f.sent();sharpSrc=sharp__default["default"](src);buildify2=function buildify2(pvar){return __awaiter(this,void 0,void 0,function(){var pngImage,rgb,err_2;return __generator(this,function(_a){switch(_a.label){case 0:_a.trys.push([0,2,,3]);pngImage=sharpSrc.resize(pvar[1],pvar[1]);if(pvar[2]){rgb=hexToRgb(options.background_color)||{r:undefined,g:undefined,b:undefined};pngImage.flatten({background:{r:rgb.r,g:rgb.g,b:rgb.b,alpha:1}});}pngImage.png();return [4,pngImage.toFile(pvar[0])];case 1:_a.sent();return [3,3];case 2:err_2=_a.sent();warn(err_2);return [3,3];case 3:return [2]}})})};folders=uniqueFolders(options);for(n in folders){folder=folders[Number(n)];fsExtra.ensureDir("".concat(target).concat(path__default["default"].sep).concat(folder));}_a1=[];for(_b in options)_a1.push(_b);_i=0;_f.label=2;case 2:if(!(_i<_a1.length))return [3,7];optionKey=_a1[_i];option=options[String(optionKey)];_c=[];for(_d in option.sizes)_c.push(_d);_e=0;_f.label=3;case 3:if(!(_e<_c.length))return [3,6];sizeKey=_c[_e];size=option.sizes[String(sizeKey)];if(!!option.splash)return [3,5];dest="".concat(target,"/").concat(option.folder);if(option.infix===true){output="".concat(dest).concat(path__default["default"].sep).concat(option.prefix).concat(size,"x").concat(size).concat(option.suffix);}else {output="".concat(dest).concat(path__default["default"].sep).concat(option.prefix).concat(option.suffix);}pvar1=[output,size,option.background,];return [4,buildify2(pvar1)];case 4:_f.sent();_f.label=5;case 5:_e++;return [3,3];case 6:_i++;return [3,2];case 7:return [2]}})})},splash:function splash(src,splashSrc,target,options){return __awaiter(this,void 0,void 0,function(){var output,block,rgb,sharpSrc,data,_a,_b,_i,optionKey,option,_c,_d,_e,sizeKey,size,dest,pvar,sharpData;return __generator(this,function(_f){switch(_f.label){case 0:block=false;rgb=hexToRgb(options.background_color)||{r:undefined,g:undefined,b:undefined};if(splashSrc===src){block=true;}if(!(block||options.splashscreen_type==="generate"))return [3,2];return [4,this.validate(src,target)];case 1:_f.sent();if(!image){process.exit(1);}sharpSrc=sharp__default["default"](src);sharpSrc.extend({top:726,bottom:726,left:726,right:726,background:{r:rgb.r,g:rgb.g,b:rgb.b,alpha:1}}).flatten({background:{r:rgb.r,g:rgb.g,b:rgb.b,alpha:1}});return [3,3];case 2:if(options.splashscreen_type==="overlay"){sharpSrc=sharp__default["default"](splashSrc).flatten({background:{r:rgb.r,g:rgb.g,b:rgb.b,alpha:1}}).composite([{input:src},]);}else if(options.splashscreen_type==="pure"){sharpSrc=sharp__default["default"](splashSrc).flatten({background:{r:rgb.r,g:rgb.g,b:rgb.b,alpha:1}});}else {throw new Error("unknown options.splashscreen_type: ".concat(options.splashscreen_type))}_f.label=3;case 3:return [4,sharpSrc.toBuffer()];case 4:data=_f.sent();_a=[];for(_b in options)_a.push(_b);_i=0;_f.label=5;case 5:if(!(_i<_a.length))return [3,11];optionKey=_a[_i];option=options[String(optionKey)];_c=[];for(_d in option.sizes)_c.push(_d);_e=0;_f.label=6;case 6:if(!(_e<_c.length))return [3,10];sizeKey=_c[_e];size=option.sizes[String(sizeKey)];if(!option.splash)return [3,9];dest="".concat(target).concat(path__default["default"].sep).concat(option.folder);return [4,fsExtra.ensureDir(dest)];case 7:_f.sent();if(option.infix===true){output="".concat(dest).concat(path__default["default"].sep).concat(option.prefix).concat(size,"x").concat(size).concat(option.suffix);}else {output="".concat(dest).concat(path__default["default"].sep).concat(option.prefix).concat(option.suffix);}pvar=[output,size];sharpData=sharp__default["default"](data);sharpData=sharpData.resize(pvar[1][0],pvar[1][1]);return [4,sharpData.toFile(pvar[0])];case 8:_f.sent();_f.label=9;case 9:_e++;return [3,6];case 10:_i++;return [3,5];case 11:return [2]}})})},icns:function icns(src,target){var _a,_b;return __awaiter(this,void 0,void 0,function(){var s,metadata,buf,icoBuf,size,out,out2,err_3;return __generator(this,function(_c){switch(_c.label){case 0:_c.trys.push([0,9,,10]);if(!image){process.exit(1);}return [4,this.validate(src,target)];case 1:_c.sent();s=sharp__default["default"](src);return [4,s.metadata()];case 2:metadata=_c.sent();return [4,s.toBuffer()];case 3:buf=_c.sent();icoBuf=void 0;if(!(metadata.width!==metadata.height))return [3,5];size=Math.min((_a=metadata.width)!==null&&_a!==void 0?_a:256,(_b=metadata.height)!==null&&_b!==void 0?_b:256);return [4,s.resize(size,size).toBuffer()];case 4:icoBuf=_c.sent();return [3,7];case 5:return [4,s.toBuffer()];case 6:icoBuf=_c.sent();_c.label=7;case 7:out=png2icons__namespace.createICNS(buf,png2icons__namespace.BICUBIC,0);if(out===null){throw new Error("Failed to create icon.icns")}fsExtra.ensureFileSync(path__default["default"].join(target,"/icon.icns"));fsExtra.writeFileSync(path__default["default"].join(target,"/icon.icns"),out);return [4,pngToIco(icoBuf)];case 8:out2=_c.sent();if(out2===null){throw new Error("Failed to create icon.ico")}fsExtra.ensureFileSync(path__default["default"].join(target,"/icon.ico"));fsExtra.writeFileSync(path__default["default"].join(target,"/icon.ico"),out2);return [3,10];case 9:err_3=_c.sent();console.error(err_3);throw err_3;case 10:return [2]}})})}};

exports["default"] = tauricon;
